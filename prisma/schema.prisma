generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  passwordHash String
  plan         Plan          @default(FREE)
  createdAt    DateTime      @default(now())
  exams        Exam[]
  attempts     ExamAttempt[]
  streak       Streak?
  stats        UserStats?
}

model Exam {
  id               String           @id @default(cuid())
  title            String
  description      String?
  userId           String
  user             User             @relation(fields: [userId], references: [id])
  sourceType       SourceType
  sourcePdfUrl     String?
  sourceText       String?          @db.Text
  difficulty       Difficulty       @default(MEDIUM)
  subject          String
  questions        Question[]
  attempts         ExamAttempt[]
  createdAt        DateTime         @default(now())
  aiModel          String
  generationStatus GenerationStatus @default(PENDING)
  generationError  String?          @db.Text
  currentStep      String?
  updatedAt        DateTime         @updatedAt
}

model Question {
  id            String       @id @default(cuid())
  examId        String
  exam          Exam         @relation(fields: [examId], references: [id])
  questionText  String       @db.Text
  questionType  QuestionType
  options       Json?
  correctAnswer String       @db.Text
  explanation   String?      @db.Text
  points        Int          @default(1)
  order         Int
}

model ExamAttempt {
  id                     String        @id @default(cuid())
  userId                 String
  user                   User          @relation(fields: [userId], references: [id])
  examId                 String
  exam                   Exam          @relation(fields: [examId], references: [id])
  status                 AttemptStatus @default(IN_PROGRESS)
  submittedAnswers       Json? // Final answers after submission
  inProgressAnswers      Json? // Answers saved during the exam session
  score                  Float?
  maxScore               Float?
  percentage             Float?
  aiFeedback             String?       @db.Text
  timeSpent              Int?
  completedAt            DateTime?
  currentQuestionIndex   Int?          @default(0)
  flaggedQuestions       Json? // Stores IDs of flagged questions

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED // Optional: if we want to track abandoned attempts
}

model Streak {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActiveDate DateTime @default(now())
  totalExams     Int      @default(0)
  totalQuestions Int      @default(0)
}

model UserStats {
  id             String @id @default(cuid())
  userId         String @unique
  user           User   @relation(fields: [userId], references: [id])
  totalExams     Int    @default(0)
  examsPassed    Int    @default(0)
  examsFailed    Int    @default(0)
  avgScore       Float  @default(0)
  totalTimeSpent Int    @default(0)
  subjectStats   Json
}

enum Plan {
  FREE
  PRO
  PREMIUM
}

enum SourceType {
  PDF
  DESCRIPTION
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
